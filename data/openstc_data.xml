<?xml version="1.0" encoding="utf-8"?>
<!--
    OpenSTC Interventions - Openerp Module to manage Cityhall technical department
    Copyright (C) 2013 Siclic www.siclic.fr

    This file is part of OpenSTC Interventions.

    OpenSTC Interventions is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as
    published by the Free Software Foundation, either version 3 of the
    License, or (at your option) any later version.

    OpenSTC Interventions is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with OpenSTC Interventions.  If not, see <http://www.gnu.org/licenses/>.
-->
<openerp>
	<data noupdate="0">
	     	<!-- mail template about has been created -->
		    <record id="openstc_email_template_ask_wait" model="email.template">
		        <field name="name">Demande d'intervention Enregistrée</field>
		        <field name="model_id" ref="model_openstc_ask"/>
		    	<field name="email_from">pierreyves.fadet@siclic.fr</field>
				<field name="email_to">pierreyves.fadet@siclic.fr</field>
				<field name="subject">Votre Demande d'intervention: ${object.name or 'inconnu'} est enregistrée</field>
				<!-- BODY HTML -->
				<field name="body_html"><![CDATA[
					<h2>Madame, Monsieur,</h2>

					<p>Nous vous confirmons que la demande d'intervention suivante a été enregistrée </p>
					<%
					from datetime import datetime
					import pytz
					%>
					<p>${ object.name } : </p>
					<p>${ object.description } </p>
				    <p>${object.write_uid.signature or ''}<br />
				    ${object.partner_id.company_id.name or ''} </p>

				]]></field>
				<!-- BODY TEXT -->
				<field name="body_text"><![CDATA[
					Madame, Monsieur,

					Nous vous confirmons que la demande d'intervention suivante a été enregistrée
					<%
					from datetime import datetime
					import pytz
					%>
					${ object.name } :
					${ object.description }
				    ${object.write_uid.signature or ''}
				    ${object.partner_id.company_id.name or ''}
		    ]]></field>
	    </record>
		<!-- mail template about has been validated -->
		<record id="openstc_email_template_ask_valid" model="email.template">
		        <field name="name">Demande d'intervention Validée</field>
		        <field name="model_id" ref="model_openstc_ask"/>
		    	<field name="email_from">pierreyves.fadet@siclic.fr</field>
				<field name="email_to">pierreyves.fadet@siclic.fr</field>
				<field name="subject">Votre Demande d'intervention: ${object.name or 'inconnu'} est validée</field>
				<!-- BODY HTML -->
				<field name="body_html"><![CDATA[
					<h2>Madame, Monsieur,</h2>

					<p>Nous vous confirmons que la demande d'intervention suivante a été validée </p>
					<%
					from datetime import datetime
					import pytz
					%>
					<p>${ object.name } : </p>
					<p>${ object.description } </p>
					<%
					date_deadline = datetime.strptime(str(object.date_deadline),"%Y-%m-%d").replace(tzinfo=pytz.utc)
					date_deadline_str = date_deadline.astimezone(pytz.timezone("Europe/Paris")).strftime(("%x").encode('utf-8'))
					date_deadline_str = date_deadline_str.decode('utf-8')
					%>
					<p>Date butoir :  ${date_deadline_str}</p>
				    <p>${object.write_uid.signature or ''}<br />
				    ${object.partner_id.company_id.name or ''} </p>

				]]></field>
				<!-- BODY TEXT -->
				<field name="body_text"><![CDATA[
					Madame, Monsieur,

					Nous vous confirmons que la demande d'intervention suivante a été validée
					<%
					from datetime import datetime
					import pytz
					%>
					<p>${ object.name } : </p>
					<p>${ object.description } </p>
					<%
					date_deadline = datetime.strptime(str(object.date_deadline),"%Y-%m-%d").replace(tzinfo=pytz.utc)
					date_deadline_str = date_deadline.astimezone(pytz.timezone("Europe/Paris")).strftime(("%x").encode('utf-8'))
					date_deadline_str = date_deadline_str.decode('utf-8')
					%>
					Date butoir :  ${date_deadline_str}
				    ${object.write_uid.signature or ''}
				    ${object.partner_id.company_id.name or ''}

		    ]]></field>
	    </record>
		<!-- mail template about has been finished -->
		<record id="openstc_email_template_ask_finished" model="email.template">
		        <field name="name">Demande d'intervention terminée</field>
		        <field name="model_id" ref="model_openstc_ask"/>
		    	<field name="email_from">pierreyves.fadet@siclic.fr</field>
				<field name="email_to">pierreyves.fadet@siclic.fr</field>
				<field name="subject">Votre Demande d'intervention: ${object.name or 'inconnu'} est terminée</field>
				<!-- BODY HTML -->
				<field name="body_html"><![CDATA[
				<h2>Madame, Monsieur,</h2>

					<%
					from datetime import datetime
					import pytz

					my_last_checkout = None
					my_checkin_str = ""
					my_last_checkout_str = ""
					%>

					% for inter in object.intervention_ids:
						% for task in inter.tasks:
						<%
							my_checkin = datetime.strptime(str(task.date_start),"%Y-%m-%d %H:%M:%S").replace(tzinfo=pytz.utc)
							my_checkout = datetime.strptime(str(task.date_end),"%Y-%m-%d %H:%M:%S").replace(tzinfo=pytz.utc)
							if my_last_checkout == None:
								my_last_checkout = my_checkout
							if my_checkout > my_last_checkout:
								my_last_checkout = my_checkout


							my_checkin_str = my_checkin.astimezone(pytz.timezone("Europe/Paris")).strftime(("%x %Hh%M").encode('utf-8'))
							my_checkout_str = my_checkout.astimezone(pytz.timezone("Europe/Paris")).strftime(("%x %Hh%M").encode('utf-8'))
							my_last_checkout_str = my_last_checkout.astimezone(pytz.timezone("Europe/Paris")).strftime(("%x %Hh%M").encode('utf-8'))

							my_checkin_str = my_checkin_str.decode('utf-8')
							my_checkout_str = my_checkout_str.decode('utf-8')
							my_last_checkout_str = my_last_checkout_str.decode('utf-8')
						%>
						% endfor
					% endfor

					<p>L'intervention <b>${object.name}</b> s'est déroulée du ${my_checkin_str} au ${my_last_checkout_str}.<br>
					Cette intervention est terminée.</p>

				   <br />
				   <p>${object.write_uid.signature or ''} <br />
				   ${object.partner_id.company_id.name or ''} </p>

				]]></field>

				<!-- BODY TEXT -->
				<field name="body_text"><![CDATA[
					Madame, Monsieur,

					<%
					from datetime import datetime
					import pytz

					my_last_checkout = None
					my_checkin_str = ""
					my_last_checkout_str = ""
					%>

					% for inter in object.intervention_ids:
						%for task in inter.tasks:
						<%
							my_checkin = datetime.strptime(str(task.date_start),"%Y-%m-%d %H:%M:%S").replace(tzinfo=pytz.utc)
							my_checkout = datetime.strptime(str(task.date_end),"%Y-%m-%d %H:%M:%S").replace(tzinfo=pytz.utc)
							if my_last_checkout == None:
								my_last_checkout = my_checkout
							if my_checkout > my_last_checkout:
								my_last_checkout = my_checkout


							my_checkin_str = my_checkin.astimezone(pytz.timezone("Europe/Paris")).strftime(("%x %Hh%M").encode('utf-8'))
							my_checkout_str = my_checkout.astimezone(pytz.timezone("Europe/Paris")).strftime(("%x %Hh%M").encode('utf-8'))
							my_last_checkout_str = my_last_checkout.astimezone(pytz.timezone("Europe/Paris")).strftime(("%x %Hh%M").encode('utf-8'))

							my_checkin_str = my_checkin_str.decode('utf-8')
							my_checkout_str = my_checkout_str.decode('utf-8')
							my_last_checkout_str = my_last_checkout_str.decode('utf-8')
						%>
						% endfor
					% endfor

					Suite à la demande d'intervention ${object.name} s'est déroulée du ${my_checkin_str} au ${my_last_checkout_str}.
					Cette réservation est terminée.

				   ${object.write_uid.signature or ''}


			    ]]></field>
	    </record>
	</data>
</openerp>